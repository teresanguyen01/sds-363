---
title: 'S&DS 363 Problem Set 6: Ordination'
author: "Franklin Wu and Teresa Nguyen"
date: "2025-04-09"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Wisconsin Forest Data Ordination

## Data Cleaning and Useful Packages

```{r}
library(vegan)
library(vegan3d)
library(mgcv)
library(MASS)
library(rgl)
```


```{r}
forest <-read.csv("../../Documents/sds-363/Wisconsin.Forest.csv")
rownames(forest) <-forest[,1]
forestenv <- matrix(forest[,17], ncol = 1)
rownames(forestenv) <- forest[, 1]
colnames(forestenv) <- c("Stage")
forest <- forest[, -c(1, 17)]
forestenv <- data.frame(forestenv)
```

## Correspondence Analysis: Inertia, Data Snaking

*Correspondence analysis*, also called reciprocal averaging, creates a 2D (or higher) plot that shows the relative positions of both rows and columns in a data matrix. In this example, we’re using it to look at relationships in the forest dataset. The closer the points are on the plot, the more closely related they are. We also look at the inertia, which is similar to variance and tells us how much of the data’s structure is captured by the plot.

```{r}
(forestca <- cca(forest))

plot(forestca, main = "Correspondence Analysis for Spider Data", type = "n")

forest
#text(spiderca, display = c("sites"), labels = rownames(spidercount), cex = 0.86)
points(forestca, pch = 19, col = "black", cex = 1)
text(forestca, display = c("sites"), labels = forest[, 1], cex = 0.7, col = "yellow")
text(forestca, "species", col = "blue", cex = 1.1)
fit <- envfit(forestca, forestenv, permutations = 1000)
plot(fit, col = "red", lwd = 3)

fit
```

We performed correspondence analysis (CA) on the counts of 14 tree species on 10 different plots in Wisconsin. We used CA to represent the count data in a 2 dimensional space, as shown in the plot. In practice, this involves comparing observed versus expected frequencies, calculating the chi-squared distances between sites, and projecting those relationships into a lower dimensional space.

Our results show inertia-analogous to variance-which helps us understand how much of the structure in the data is explained by each axis. The total inertia of 0.7215 suggests there is meaningful structure in the data. CA1 captures 0.4506 (or about 62.5% of the total inertia) while CA2 captures an additional 0.0899 (or about 12% of the total inertia). 

Based on the plot of the first two CA directions, there appears to be mild evidence of data snaking-the cluster of points in the center appear to curve slightly. This matches our intuition: forests tend to follow an ecological gradient of succession as they develop over time which is reflected by the non-linear structure in higher dimensional space, which appears as the snaking pattern we observe when it's reflected into 2d space.

Based on the results of CA and the plot, we can conclude that CA1 captures most of the variation in our data. Sites to the right of CA1 are more likely to be associated with Shagbark hickory. Meanwhile, sites 3 and 10 appear to be very distinct from the other sites (that are clustered together) and are associated with the species Butternut. Our environmental variable stage (red arrow) is shown pointing to the left, indicating that sites along the left (with negative CA1) tend to have an earlier stage and vice versa for sites that are more near the center or to the right.

## Multidimensional Scaling for 1, 2, 3 Dimensions

Multidimensional Scaling (MDS) aims to find a low-dimensional representation of data that preserves the original distances or dissimilarities between items. In this example, we evaluate how well MDS represents our data in 1D, 2D, and 3D using stress, a measure of distortion.

To test this, we compare the stress values of the original forest dataset to those from randomized versions. For each dimensionality (1, 2, and 3), we shuffle the rows of the dataset 20 times, run MDS on each shuffled version, and record the resulting stress values. Then we compute the stress for the original dataset to see how much structure is lost or preserved when reducing dimensionality. Lower stress indicates a better representation of the original data structure.

```{r results = 'hide'}
results <- matrix(NA, 21, 3)
for (j in 1:3){
  for (i in 1:20){
    temp <- forest[shuffle(nrow(forest)), 1]
    for (k in 2:11) { temp <- cbind(temp, forest[shuffle(nrow(forest)), k]) }
    #store stress
    results[i, j] <- metaMDS(temp, k = j, distance = "euclidean")$stress
  }
  results[21, j] <- metaMDS(forest[, 1:11], k = j, distance = "euclidean")$stress
}
```

We performed multidimensional scaling using Euclidean distances for 1,2 and 3 dimensions. We used the ```metaMDS``` function to calculate the stress - the amount of distortion generated by MDS due to representing a higher dimension - values for our actual data and randomized data at the aforementioned number of dimensions.

```{r}

plot(c(1:3), results[21, ], type = "b", col = "blue", lwd = 3, 
     ylim = c(0, max(results)), xlab = "Dimensions", ylab = "Stress", pch = 19, 
     main = "MDS for Stream Data, Euclidean Distance")
mins <- apply(results[1:20, ], 2, min)
maxs <- apply(results[1:20, ], 2, max)
meds <- apply(results[1:20, ], 2, median)

for (i in 1:3){
  points(rep(i, 3), c(mins[i], meds[i], maxs[i]), type = "b", col = "red", 
         lwd = 3, pch = 19)
}
legend(3.5, (.9*max(results)), c("MDS Solution", "20 Permutations"), lwd = 3, 
       col = c("blue", "red"))
```
From our scree plot of stress at each dimension, we can see that two dimensions capture most of the structure in the data. The stress value drops significantly from one to two dimensions—falling below our 0.1 threshold. Additionally, the spread of stress values from the shuffled data lies slightly above the two-dimensional mark, suggesting that two dimensions provide an optimal balance between simplicity and capturing the structure of the original data.

## 2 dimensional plot of MDS

```{r}
(forestmds <- metaMDS(forest))
plot(forestmds, main = "NMDS for Forest Data", type = "n")
points(forestmds, pch = 19, col = "black", cex = 1)
text(forestmds, display = c("sites"), labels = forest[, 1], cex = 0.5,  
     col = "yellow")
text(forestmds, "species", col = "blue", cex = 1.1)

(fit <- envfit(forestmds, forestenv, permutations = 1000))
plot(fit, col = "red", lwd = 3)
```
We created a plot based on the results of our 2-dimension MDS. This plot is more dispersed than our result from CA and shows a natural progression relating to stage along the first axis from left to right.

```{r}
fig <- ordiplot(forestmds, type = "none", cex = 1.1, main = "NMDS for Forest Data")
text(fig, "species", col = "red", cex = 0.7)
text(fig, "sites", col = "black", cex = 0.7)
plot(fit)
tmp1 <- with(forestenv, ordisurf(forestmds, Stage, add = TRUE))

vis.gam(tmp1, main = "Stage")
```
We overlaid a continuous variable relating to the stage of each of our plots. Our test gave us a p-value of 0.000999, which tells us that stage is a statistically significant variable associated with variation in species composition. 

We also created a wireplot to visualize how stage varies across the ordination space. The plot shows a gradient: points on the left correspond to earlier successional stages, while those on the right represent later stages. This suggests that the first axis is strongly associated with stage. This pattern is consistent with the dataset—plots with lower stages (A, B, C) appear on the left side of the chart, while higher stage plots (H, I, J) are located on the right.

Overall, the progression of the stages is smooth and follows the overlay of our stage vector, which points from the left to the right—mirroring the underlying ecological gradient in a lower-dimensional representation.

## Canonical Correspondence Analysis

Canonical Correspondence Analysis (CCA) is similar to correspondence analysis, but with an added step that constrains the ordination based on environmental variables. This allows us to directly relate species composition to environmental gradients.

```{r}
forestcca <- cca(forest, forestenv, scale = "FALSE")
plot(forestcca)

plot(forestcca, main = "CCA for Forest Data", type = "n")
points(forestcca, pch = 19, col = "black", cex = 1)
text(forestcca, "species", col = "blue", cex = 1.1)

fit <- envfit(forestcca, forestenv, permutations = 1000)
plot(fit, col = "red", lwd = 3)
fit

summary(forestcca)
```

We can use Canonical Correspondence Analysis (CCA) to examine  the relationship between tree species and the environmental variable stage. Based on the results from above, stage accounts for about 56.54% of the total inertia (variation in tree species) while the remaining 43.46% is explained by other factors. The first canonical axis is stage which captures the aforementioned inertia while the other axis only adds about 14.85%. 

The CCA plots look similar to the ones we observed in Correspondence Analysis (CA), showing similar orientation to tree species among the different plots. Overall, our CCA analysis emphasize that successional stage is a strong driver of tree species patterns, while other factors still play an important role as well.*

In conclusion, multidimensional scaling (with 2 dimensions) was the most appropriate method for capturing the structure in our data. Both Correspondence analysis and Canonical Correspondence Analysis produced very similar patterns in the plot with a mild snaking pattern observed among the points, with key relationships such as the association between butternut and plots 3 & 10 or the overall direction of the stage vector. CA underscored the significance of the first axis in explaining a large sum of the total inertia, while CCA (more specifically) highlighted the importance of stage as a variable in understanding species patterns. 

MDS also supported this interpretation, showing a smooth progression of successional stages from left to right in the plot—reinforced by both the wireplot and the environmental vector. Altogether, our analyses helped unpack the different relationships between our tree species and plots in addition to quantifying the importance of stage as an environmental variable.

